---
title: "Modelos de regressão para variáveis positivas"
author: "Gabriel Stein 197466, Gabriela Vechini 172625"
output:
  beamer_presentation:
    theme: "default"
    colortheme: "seahorse"
    fig_crop: no
header-includes:
  - \usepackage[utf8]{inputenc}
  - \usepackage[brazil, english, portuguese]{babel}
  - \usepackage[utf8]{inputenc}
  - \usepackage[T1]{fontenc}
  - \usepackage[fixlanguage]{babelbib}
  - \usepackage{times}

  - \usepackage{graphicx}
  - \usepackage{wrapfig}
  - \usepackage{pdfpages}
  
  - \usepackage{amsfonts}
  - \usepackage{amssymb}
  - \usepackage{amsmath}
  
  - \usepackage{fancyhdr}
  - \usepackage{subcaption}
  - \usepackage{booktabs}
  - \usepackage{caption}
  - \usepackage{float}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE,
  warning = FALSE,
  tidy.opts = list(width.cutoff = 60),
  tidy = TRUE
  )
options(
  OutDec = ",", 
  knitr.table.format = "latex", 
  xtable.comment = FALSE
  )
```

```{r}
library(HoRM)
library(tidyverse)
library(survival)
library(insuranceData)
library(magrittr)
library(readxl)
library(corrplot)
library(haven)
library(fitdistrplus)
library(ssym)
source("diag_norm.R")
source("envel_norm.R")
library(gridExtra)
library(knitr)
library(kableExtra)
library(formattable)
library(statmod)
```

```{r}
data(Snacks)
snacks <- Snacks %>% as_tibble() %>% mutate(type = case_when(type == 1 ~ "A",
                                                             type == 2 ~ "B",
                                                             type == 3 ~ "C",
                                                             type == 4 ~ "D",
                                                             type == 5 ~ "E"))
```

## Introdução: Variáveis positivas
	
- Variáveis explicativas com dados nulos ou positivos, quais retornarão variável resposta também positiva.
- Precisam ser positivas para estarem dentro do suporte das distribuições que serão supostas.
- Emglobam números interiros e contínuos.
	
## Exemplos de distribuições e suas ultilizações

- Poisson: dados de contagem, poucos zeros, números inteiros positivos;
- Binomial: poucos zero, números inteiros positivos;
- Binomial Negativa: muitos zeros, números inteiros positivos;
- Weibull: base de dados pequena, valores continuos, reais positivos;
- Birnbaum-Saunders: dados assimétricos, poucos zeros, números reais positivos;
- Gama: dados assimétricos, poucos zeros, números reais positivos;
- Normal-Inversa: dados assimétricos, poucos zeros, números reais positivos;

## Dados 

- Foi realizado um experimento de desenvolvimento de produto no Departamento de Nutrição da Faculdade de Saúde Públida da USP com 5 formas de um alimento. Em que a gordua vegetal hidrogenada foi subtitíuda por óleo de carnola.
- Formas: A (22% de gordura, 0%
de óleo de canola), B (0% de gordura, 22% de óleo de canola), C (17% de
gordura, 5% de óleo de canola), D (11% de gordura, 11% de óleo de canola)
e E (5% de gordura, 17% de óleo de canola).
- O experimento foi realizado ao longo de 20 semanas, em cada semana par 15 embalagens de cada tipo de produto era análisado em laboratório.
- Aqui vamos estudar o comportamento da textura através da força necessária para o cisalhamento.

## Banco de dados

```{r}
snacks %>% head(8) %>% set_colnames(c("Cisalhamento","Forma","Semana")) %>%
  kable("latex", booktabs = T, caption = "Primeiras 8 linhas do banco de dados") %>% kable_styling(font_size = 9)
```

## Análise exploratória por forma

```{r}
snacks %>% ggplot(aes(y = texture, x = type)) + geom_boxplot() +
  labs(x = "Forma", y = "Cisalhamento")
```

## Análise exploratória por forma

```{r}
sumario.forma <- snacks %>% group_by(type) %>% summarise(media = mean(texture), dp = sd(texture), cv = dp/media) %>%
  mutate(cv = percent(as.numeric(cv))) %>%
  set_colnames(c("Grupo", "Média", "DP", "CV")) %>% t() 
colnames(sumario.forma) <- sumario.forma[1,]
sumario.forma <- sumario.forma[-1,]
kable(sumario.forma,"latex", booktabs = T) %>% kable_styling(font_size = 9)
```

## Análise exploratória por semana

```{r}
snacks %>% ggplot(aes(y = texture, x = factor(week))) + geom_boxplot() +
  labs(x = "Semana", y = "Cisalhamento")
```

## Análise exploratória por semana

```{r}
sumario.semana <- snacks %>% group_by(week) %>% summarise(media = mean(texture), dp = sd(texture), cv = dp/media) %>%
  mutate(cv = percent(as.numeric(cv))) %>%
  set_colnames(c("Grupo", "Média", "DP", "CV")) %>% t() 
colnames(sumario.semana) <- as.integer(sumario.semana[1,])
sumario.semana <- sumario.semana[-1,]
kable(sumario.semana[,1:5],"latex", booktabs = T) %>% kable_styling(font_size = 8)
kable(sumario.semana[,6:10],"latex", booktabs = T) %>% kable_styling(font_size = 8)
```

<!-- \begin{table}[H] -->
<!-- \centering\begingroup\fontsize{8}{11}\selectfont -->

<!-- \begin{tabular}{lrrrrr} -->
<!-- \hline -->
<!--   & 2 & 4 & 6 & 8 & 10\\ -->
<!-- \hline -->
<!-- Média & 50,9513333 & 44,6588000 & 50,0828000 & 55,5653333 & 60,1502667\\ -->
<!-- DP & 13,1233342 & 9,7580618 & 15,9687690 & 16,2805286 & 14,7190660\\ -->
<!-- CV & 0,2575661 & 0,2185026 & 0,3188474 & 0,2929979 & 0,2447049\\ -->
<!-- \hline -->
<!--   & 12 & 14 & 16 & 18 & 20\\ -->
<!-- \hline -->
<!-- Média & 57,8350667 & 71,571733 & 65,1784000 & 60,3740000 & 52,4552000\\ -->
<!-- DP & 13,6111127 & 20,168339 & 16,9516530 & 10,2482286 & 12,5844843\\ -->
<!-- CV & 0,2353436 & 0,281792 & 0,2600808 & 0,1697457 & 0,2399092\\ -->
<!-- \end{tabular} -->
<!-- \endgroup{} -->
<!-- \end{table} -->

## Análise exploratória por semana e por forma

```{r}
snacks %>% ggplot(aes(y = texture, x = week)) + geom_point() + facet_wrap(~ type) 
```

## Modelo normal

Suposições:

- Normalidade
- Homocedasticidade
- Independencia

Modelo:



$$ Y_{ijk} = \alpha_i +  \alpha_i\beta\cos(f(x_{j}))$$

```{r}
snacks.fit.normal <- snacks %>% mutate(week.cos = cos((-pi*week + 14*pi)/10)) %>%
  lm(texture ~ -1 + type * week.cos, .)
# summary(snacks.fit.normal)
```

## Diágnóstico Para Modelo Normal

```{r}
diagnorm(snacks.fit.normal)
naolista <- data.frame(summary(snacks.fit.normal)[4])
round(naolista, 4)
coefdisp<- data.frame(summary(snacks.fit.normal)[8])
paste("R2: ", round(coefdisp,3))
```

## Alternativa

A força de cisalhamento é uma variável positiva e tem uma distribuição assimétrica à direitra, o que indica que ela pode ser modelada por um distribuição normal inversa ou gama.
Aparentemente a resposta dado a semana tem uma resposta periódica.

Seja $Y_{ijk}$ a força de cisalhamento da $k$-ésima réplica do $i$-ésimo grupo na $j$-ésima semana, onde $k = 1,...,15$, $k = 2,4,6,...,20$ e $i = 1(A),2(B),3(C),4(D),5(E)$. Suponha $Y_{ijk} \sim G(\mu_{ij}\phi)$ e $Y_{ijk} \sim NI(\mu_{ij}\phi)$ e sua parte sistemática

$$ \mu_{ij} = \alpha_i + \beta\cos(ax_j+b)$$

em que $x_j$ é a $j$-ésima semana, $\alpha_i$ são os efeitos das formas, $\beta$ o efeito da semana e $a$ e $b$ foram escolhidos empiricamente.

```{r}
# snacks.fit.gamma.lin <- snacks %>%
#   glm(texture ~ type + week, family = Gamma(link = "identity"), .)
# summary(snacks.fit.gamma)
```

## Gamma

```{r}
snacks.fit.gamma.cos <- snacks %>% mutate(week.cos = cos((-pi*week + 14*pi)/10)) %>%
  glm(texture ~ type + week.cos, family = Gamma(link = "identity"), .)
summary(snacks.fit.gamma.cos)
```

```{r}
# cbind(snacks,fitted(snacks.fit.gamma.cos)) %>% gather(origem, valor, -type, -week) %>%
#     ggplot(aes(x = week, y = valor, color = origem)) + geom_point() + facet_wrap(~ type)
```

```{r}
# residuos gama
X <- model.matrix(snacks.fit.gamma.cos)
n <- nrow(X)
p <- ncol(X)
w <- snacks.fit.gamma.cos$weights
W <- diag(w)
H <- solve(t(X)%*%W%*%X)
H <- sqrt(W)%*%X%*%H%*%t(X)%*%sqrt(W)
h <- diag(H)
fi <- gamma.shape(snacks.fit.gamma.cos)$alpha
ts <- resid(snacks.fit.gamma.cos,type="pearson")*sqrt(fi/(1-h))
td <- resid(snacks.fit.gamma.cos,type="deviance")*sqrt(fi/(1-h))
grafico.residuo.gama <- tibble(fit = fitted(snacks.fit.gamma.cos), ts = ts) %>% ggplot(aes(x = fit, y = ts)) + geom_point()
grafico.deviance.gama <- tibble(fit = fitted(snacks.fit.gamma.cos), td = td) %>% ggplot(aes(x = fit, y = td)) + geom_point()
```

## Normal Inversa

```{r}
# snacks.fit.ninv <- snacks %>%
#   glm(texture ~ -1 + type + week, family = inverse.gaussian(), .)
# summary(snacks.fit.ninv)
```


```{r}
snacks.fit.ninv.cos1 <- snacks %>% mutate(week.cos = cos((-pi*week + 14*pi)/10)) %>%
  glm(texture ~ type * week.cos, family = inverse.gaussian(link = "identity"), .)
snacks.fit.ninv.cos2 <- snacks %>% mutate(week.cos = cos((-pi*week + 14*pi)/10)) %>%
  glm(texture ~ -1 + type + week.cos, family = inverse.gaussian(link = "identity"), .)
```

```{r}
cbind(snacks,fitted(snacks.fit.ninv.cos1)) %>% gather(origem, valor, -type, -week) %>%
    ggplot(aes(x = week, y = valor, color = origem)) + geom_point() + facet_wrap(~ type)
```

```{r}
cbind(snacks,fitted(snacks.fit.ninv.cos2)) %>% gather(origem, valor, -type, -week) %>%
    ggplot(aes(x = week, y = valor, color = origem)) + geom_point() + facet_wrap(~ type)
```


## Residuo pearson inversa

```{r}
X <- model.matrix(snacks.fit.ninv.cos1)
n <- nrow(X)
p <- ncol(X)
w <- snacks.fit.ninv.cos1$weights
W <- diag(w)
H <- solve(t(X)%*%W%*%X)
H <- sqrt(W)%*%X%*%H%*%t(X)%*%sqrt(W)
h <- diag(H)
soma <- resid(snacks.fit.ninv.cos1, type="pearson")
soma <- sum(soma^2)
fi <- (n-p)/soma
ts <- resid(snacks.fit.ninv.cos1,type="pearson")*sqrt(fi/(1-h))
td <- resid(snacks.fit.ninv.cos1,type="deviance")*sqrt(fi/(1-h))
grafico.residuo.ninv1 <- tibble(fit = fitted(snacks.fit.ninv.cos1), ts = ts) %>% ggplot(aes(x = fit, y = ts)) + geom_point()
grafico.deviance.ninv1 <- tibble(fit = fitted(snacks.fit.ninv.cos1), td = td) %>% ggplot(aes(x = fit, y = td)) + geom_point()
```

```{r}
X <- model.matrix(snacks.fit.ninv.cos2)
n <- nrow(X)
p <- ncol(X)
w <- snacks.fit.ninv.cos2$weights
W <- diag(w)
H <- solve(t(X)%*%W%*%X)
H <- sqrt(W)%*%X%*%H%*%t(X)%*%sqrt(W)
h <- diag(H)
soma <- resid(snacks.fit.ninv.cos2, type="pearson")
soma <- sum(soma^2)
fi <- (n-p)/soma
ts <- resid(snacks.fit.ninv.cos2,type="pearson")*sqrt(fi/(1-h))
td <- resid(snacks.fit.ninv.cos2,type="deviance")*sqrt(fi/(1-h))
grafico.residuo.ninv2 <- tibble(fit = fitted(snacks.fit.ninv.cos2), ts = ts) %>% ggplot(aes(x = fit, y = ts)) + geom_point()
grafico.deviance.ninv2 <- tibble(fit = fitted(snacks.fit.ninv.cos2), td = td) %>% ggplot(aes(x = fit, y = td)) + geom_point()
```

## Residuo de Pearson Modelo Gama vs Modelo Normal Inversa

```{r}
grid.arrange(grafico.residuo.gama, grafico.residuo.ninv2, ncol = 2)
```

<!-- ## Resíduo Componente do Desvio -->

<!-- ```{r} -->
<!-- grid.arrange(grafico.deviance.gama, grafico.deviance.ninv2, ncol = 2) -->
<!-- ``` -->

<!-- ## Resíduo de Pearson com e sem interação -->

<!-- ```{r} -->
<!-- grid.arrange(grafico.residuo.ninv1, grafico.residuo.ninv2, ncol = 2) -->
<!-- ``` -->

<!-- ## Resíduo Componente do Desvio com e sem interação -->

<!-- ```{r} -->
<!-- grid.arrange(grafico.deviance.ninv1, grafico.deviance.ninv2, ncol = 2) -->
<!-- ``` -->

<!-- ## Snacks Modelo Gama -->

<!-- ```{r} -->
<!-- fit.model <- snacks.fit.gamma.cos -->
<!-- source("diag_gama.r") -->
<!-- ``` -->

<!-- ## Snacks Modelo Gama  -->

<!-- ```{r, fig.height=7} -->
<!-- fit.model <- snacks.fit.gamma.cos -->
<!-- source("enve_gamma.R") -->
<!-- ``` -->

## Predição

```{r}
# predicao
ilink <- family(snacks.fit.ninv.cos2)$linkin
pd <- snacks %>% group_by(type, week) %>% summarise(n = n()) %>% mutate(week.cos = cos((-pi*week + 14*pi)/10))
pd <- cbind(pd, predict(snacks.fit.ninv.cos2, pd, type = "link", se.fit=T)[1])
estimativa <- snacks.fit.ninv.cos2$coefficients
pd <- mutate(pd, mi = case_when(type == "A" ~ estimativa[1] + estimativa[6]*week.cos,
                                type == "B" ~ estimativa[2] + estimativa[6]*week.cos,
                                type == "C" ~ estimativa[3] + estimativa[6]*week.cos,
                                type == "D" ~ estimativa[4] + estimativa[6]*week.cos,
                                type == "E" ~ estimativa[5] + estimativa[6]*week.cos),
             dispersao = summary(snacks.fit.ninv.cos2)$dispersion)
pd <- mutate(pd, Fitted = ilink(fit),
             Upper = qinvgauss(0.975, mean = mi, dispersion = dispersao),
             Lower = qinvgauss(0.025, mean = mi, dispersion = dispersao))

ggplot() +
    geom_ribbon(data = pd, aes(ymin = Lower, ymax = Upper, x = week),
                fill = "steelblue2", alpha = 0.5) +
    geom_line(data = pd, aes(y = Fitted, x = week)) + facet_wrap(~ type) +
    geom_point(data = snacks, aes(x = week, y = texture))

```

## Snacks Modelo Normal Inversa

```{r}
fit.model <- snacks.fit.ninv.cos2
source("daig_ninv.R")
```

## Snacks Modelo Normal Inversa

```{r, fig.height=7}
fit.model <- snacks.fit.ninv.cos2
source("envel_ninv.R")
naolista <- data.frame(summary(snacks.fit.ninv.cos2)[12])
round(naolista, 4)
coefdisp<- data.frame(summary(snacks.fit.ninv.cos2)[14])
paste("Coeficiente de dispersão: ", round(coefdisp,4))
```

## Bibliografia
